---
phase: 11-error-recovery-resume
plan: 01
type: tdd
domain: go-cli
---

<objective>
Create state persistence package for tracking lifecycle execution progress.

Purpose: Enable saving execution state when workflows fail, allowing later resume from the failure point.
Output: New `internal/state` package with State struct, Save, and Load functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@internal/lifecycle/executor.go
@internal/router/lifecycle.go

**Design decisions:**

- State file location: `.bmad-state.json` in current working directory
- JSON format for human-readability and easy debugging
- State tracks: story key, step index (which workflow in lifecycle)
- Step index is the index into router.GetLifecycle() result
  </context>

<feature>
  <name>Lifecycle State Persistence</name>
  <files>internal/state/state.go, internal/state/state_test.go</files>
  <behavior>
    State struct with fields:
    - StoryKey string - the story being processed
    - StepIndex int - index of the NEXT step to execute (0-based)
    - TotalSteps int - total steps in lifecycle for validation
    - StartStatus string - status when lifecycle started (for validation)

    Save(state State) error:
    - Serializes state to JSON
    - Writes to .bmad-state.json atomically (tmp file + rename)
    - Returns error if write fails

    Load() (State, error):
    - Reads .bmad-state.json
    - Returns ErrNoState if file doesn't exist
    - Returns error if file is invalid JSON
    - Returns State if successful

    Clear() error:
    - Removes .bmad-state.json if it exists
    - Returns nil if file doesn't exist (idempotent)

    Exists() bool:
    - Returns true if .bmad-state.json exists

    Cases:
    - Save writes valid JSON to file
    - Load returns saved state
    - Load returns ErrNoState when file missing
    - Load returns error for invalid JSON
    - Clear removes existing file
    - Clear is idempotent (no error if file missing)
    - Exists returns true when file exists
    - Exists returns false when file missing

  </behavior>
  <implementation>
    - State struct with JSON tags
    - Save: json.Marshal + atomic write (temp file + rename)
    - Load: os.ReadFile + json.Unmarshal
    - Clear: os.Remove with os.IsNotExist check
    - Exists: os.Stat
    - ErrNoState as sentinel error for Load
  </implementation>
</feature>

<verification>
go test ./internal/state/... -v
</verification>

<success_criteria>

- All tests pass
- State can be saved and loaded correctly
- Clear is idempotent
- ErrNoState distinguishes "no state" from "read error"
  </success_criteria>

<output>
After completion, create `.planning/phases/11-error-recovery-resume/11-01-SUMMARY.md`:

# Phase 11 Plan 01: State Persistence Summary

**[One-liner describing what shipped]**

## Performance

- Duration: X min
- TDD Phases: RED, GREEN, REFACTOR (if any)

## RED Phase

[What tests were written, why they failed]

## GREEN Phase

[What implementation made them pass]

## REFACTOR Phase (if any)

[What cleanup was done]

## Files Created/Modified

- `internal/state/state.go` - State struct, Save, Load, Clear, Exists
- `internal/state/state_test.go` - Test suite

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Any issues and resolutions]

## Next Phase Readiness

[Ready for 11-02: Executor Resume Support]
</output>
